name: Deploy to Kubernetes

on:
  push:
    branches: [ "master", "main" ]
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: 'latest'

    - name: Configure kubectl with cloud credentials
      run: |
        # This step would configure kubectl with your cloud provider's credentials
        # Example for Azure AKS:
        # az aks get-credentials --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} --name ${{ secrets.AKS_CLUSTER_NAME }}
        
        # Example for AWS EKS:
        # aws eks --region ${{ secrets.AWS_REGION }} update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }}
        
        # Example for GKE:
        # gcloud container clusters get-keeper --zone ${{ secrets.GKE_ZONE }} --project ${{ secrets.GCP_PROJECT_ID }} ${{ secrets.GKE_CLUSTER_NAME }}
        
        # For now, we'll skip this step - you'll need to configure this based on your cloud provider
        
    - name: Run Helm dependency update
      run: |
        cd todo-chatbot
        helm dependency update

    - name: Deploy to Kubernetes using Helm
      run: |
        # Replace these values with your actual container image names and tags
        helm upgrade --install todo-chatbot ./todo-chatbot \
          --namespace todo-app \
          --create-namespace \
          --set backend.image.repository=${{ secrets.DOCKER_USERNAME }}/todo-backend \
          --set backend.image.tag=${{ github.sha }} \
          --set frontend.image.repository=${{ secrets.DOCKER_USERNAME }}/todo-frontend \
          --set frontend.image.tag=${{ github.sha }} \
          --wait